Issue #21690: SASL_SIGNATURE_MISMATCH: The server did not return the correct signature
URL: https://github.com/supabase/supabase/issues/21690
Labels: bug
Status: closed
================================================================================

PROBLEM:
# Bug report

<!-- 

⚠️ We receive a lot of bug reports which have already been solved or discussed. If you are looking for help, please try these first:

- Docs: https://docs.supabase.com
- Discussions: https://github.com/supabase/supabase/discussions
- Discord: https://discord.supabase.com

Before opening a bug report, please verify the following: 

-->

- [ ] I confirm this is a bug with Supabase, not with my own application. 
- [x] I confirm I have searched the [Docs](https://docs.supabase.com), GitHub [Discussions](https://github.com/supabase/supabase/discussions), and [Discord](https://discord.supabase.com). 

## Describe the bug

I recently switched from a local postgres database to supabase and using drizzle as the ORM.

This is the drizzle configuration (the app is a discord bot, so long-running)

```ts
import * as schema from '../schema';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from "postgres";

export const sql = postgres({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  max: 1,
})

export const db = drizzle(sql, { schema });
```

EDIT: All these throw a connection error, whether it is `pg` or `postgres`
```ts
const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
   },
})
// SASL_SIGNATURE_MISMATCH

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
    cert,
   },
})
// SASL_SIGNATURE_MISMATCH

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: { cert },
})
// SELF_SIGNED_CERT_IN_CHAIN

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
    ca: cert,
   },
})
// SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing
```

On the first request to the database I get the following:

```
app-1  | 33 |   return error
app-1  | 34 | }
app-1  | 35 | 
app-1  | 36 | function generic(code, message) {
app-1  | 37 |   const error = Object.assign(new Error(code + ': ' + message), { code })
app-1  | 38 |   Error.captureStackTrace(error, generic)
app-1  |              ^
app-1  | error: SASL_SIGNATURE_MISMATCH: The server did not return the correct signature
app-1  |  code: "SASL_SIGNATURE_MISMATCH"
app-1  | 
app-1  |       at generic (/usr/src/app/node_modules/postgres/src/errors.js:38:9)
app-1  |       at SASLFinal (/usr/src/app/node_modules/postgres/src/connection.js:721:19)
app-1  |       at /usr/src/app/node_modules/postgres/src/connection.js:14:16
app-1  |       at asyncFunctionResume (native:1:1)
app-1  |       at Authentication (/usr/src/app/node_modules/postgres/src/connection.js:9:1)
app-1  |       at handle (/usr/src/app/node_modules/postgres/src/connection.js:813:5)
app-1  |       at data (/usr/src/app/node_modules/postgres/src/connection.js:553:5)
app-1  |       at addChunk (native:1:1)
app-1  |       at readableAddChunk (native:1:1)
app-1  |       at data (native:1:1)
app-1  | error: script "start" exited with code 1
app-1 exited with code 1
```

However, if use a connection string with the exact same values (env variables joined in the format of the connection string) the connection works.

I'd prefer to use the object notation in the `postgres()` connection options

## To Reproduce

Source code can be found here <https://github.com/noook/discord-mbti>

## Expected behavior

Object notation should behave the same as the connection string

## Screenshots

Database connection on supabase dashboard
<img width="893" alt="image" src="https://github.com/supabase/supabase/assets/19751938/bb29b5fa-55f6-4e8b-8f2c-197ee4ed7a84">


## System information

- OS: Linux (docker)
- Version of supabase-js: not used
- bun 1.0.29

## Additional context

-


DISCUSSION/SOLUTIONS:

--- Comment 1 by encima ---
Hi there, if it is working with the connection string but not the individual parameters, then there is likely some issue with the library.
I would recommend using the connection string when that works. 
If you do need to use the parameters, then you may need to add additional options, such as: 
```
ssl: { rejectUnauthorized: false}
```


--- Comment 2 by noook ---
This option didn't help in my situation, so I sticked with the connection string.

--- Comment 3 by SumitBando ---
Seeing the same issue, randomly, when using postgress.js without Drizzle

--- Comment 4 by vicvinc ---
meet the same situation, here is my connection init code:
```ts
    const queryConnection = postgres(process.env.DATABASE_URL!, {
        ssl: { rejectUnauthorized: false },
        prepare: false
    });
```

--- Comment 5 by noook ---
Actually, I cannot connect anymore, @encima  I don't know why.
Either with a connection string, with an object, with `ssl: { rejectUnauthorized: false }`, I am just getting 
`SASL_SIGNATURE_MISMATCH` or `SELF_SIGNED_CERT_IN_CHAIN` when using the following configuration (cert is the certificate provided by Supabase on the dashboard)

I tried with both `pg` and `postgres`.

```ts
const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
   },
})
// SASL_SIGNATURE_MISMATCH

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
    cert,
   },
})
// SASL_SIGNATURE_MISMATCH

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: { cert },
})
// SELF_SIGNED_CERT_IN_CHAIN

const client = postgres(import.meta.env.DATABASE_URL, {
  ssl: {
    rejectUnauthorized: false,
    ca: cert,
   },
})
// SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing
```
